import { createPagesFunctionHandler } from "@remix-run/cloudflare-pages"
// @ts-ignore - the server build file is generated by `remix vite:build`
import * as build from "../build/server"

const remix = createPagesFunctionHandler({
  build,
})

export const onRequest: PagesFunction = async (ctx) => {
  const maxRetry = 2

  for (let i = 0; i < maxRetry; i++) {
    try {
      const res = await remix(ctx)

      if (res.body) {
        const text = await res.text()
        return new Response(text, res)
      }
      return res
    } catch (err) {
      console.error(`attempt ${i + 1} failed`, err)

      if (i === maxRetry - 1) {
        return new Response("Internal Server Error", { status: 500 })
      }

      await new Promise((r) => setTimeout(r, 500))
    }
  }

  return new Response("Unreachable", { status: 500 })
}
