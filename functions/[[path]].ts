import { createPagesFunctionHandler } from "@remix-run/cloudflare-pages"
// @ts-ignore - the server build file is generated by `remix vite:build`
import * as build from "../build/server"

const remix = createPagesFunctionHandler({ build })

export const onRequest: PagesFunction = async (ctx) => {
  const url = new URL(ctx.request.url)
  const retried = url.searchParams.get("__retry") === "1"

  try {
    return await remix(ctx)
  } catch (err) {
    console.error("first attempt failed", err)
    if (retried) throw err

    await ctx.waitUntil(new Promise((r) => setTimeout(r, 1000))) // 短いバックオフ
    url.searchParams.set("__retry", "1")
    return Response.redirect(url, 302)
  }
}
